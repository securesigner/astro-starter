---
/**
 * Blog Index Page
 * ===============================================
 * Lists all published blog posts sorted by date descending.
 * Features:
 * - Paginated blog post listing
 * - Client-side category filtering
 * - Featured post highlighting
 * - Glass morphism card styling
 * - SEO optimized with structured data
 *
 * URL: /blog/
 */

import { getCollection } from 'astro:content';
import { SITE } from '@/data/site';
import Layout from '../../layouts/Layout.astro';
import CTASection from '../../components/CTASection.astro';
import BlogCard from '../../components/BlogCard.astro';
import PageBackground from '../../components/PageBackground.astro';
import SectionConnector from '../../components/SectionConnector.astro';
import AnimatedSection from '../../components/AnimatedSection.astro';

// Page metadata
const pageTitle = 'Blog';
// CUSTOMIZE: Update this description to match your blog's focus
const pageDescription = 'Practical guides and insights on building better websites, improving performance, and growing your business online. No fluff, just actionable advice.';

// Fetch all blog posts, filter drafts, and sort by date
const allPosts = await getCollection('blog', ({ data }) => {
  // In production, filter out drafts
  return import.meta.env.PROD ? data.draft !== true : true;
});

// Sort by date descending (newest first)
const sortedPosts = allPosts.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Get unique categories for filtering
const allCategories = [...new Set(sortedPosts.flatMap(post => post.data.categories || []))];
---

<Layout
  title={pageTitle}
  description={pageDescription}
  type="website"
>
  <!-- Schema.org Blog structured data -->
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Blog",
      "name": `${SITE.title} Blog`,
      "description": pageDescription,
      "url": `${SITE.url}/blog/`,
      "publisher": {
        "@type": "Organization",
        "name": SITE.title,
        "url": SITE.url
      },
      "blogPost": sortedPosts.slice(0, 10).map(post => ({
        "@type": "BlogPosting",
        "headline": post.data.title,
        "datePublished": post.data.date.toISOString(),
        "url": `${SITE.url}/blog/${post.slug}/`
      }))
    })} />
  </Fragment>

  <PageBackground>
  <!-- Main Content -->
  <main class="relative z-10 min-h-screen">
    <!-- Hero Section -->
    <section class="relative py-16 md:py-24 overflow-hidden">
      <!-- Decorative Gradient Blobs -->
      <div
        class="absolute top-8 right-[5%] sm:right-[10%] w-48 h-48 sm:w-72 sm:h-72 md:w-80 md:h-80 bg-linear-to-br from-emerald-200/40 dark:from-emerald-800/20 to-teal-100/30 dark:to-teal-900/15 rounded-full blur-3xl pointer-events-none"
        aria-hidden="true"
      />
      <div
        class="absolute -bottom-10 left-[2%] sm:left-[5%] w-40 h-40 sm:w-56 sm:h-56 bg-linear-to-tr from-amber-100/50 dark:from-amber-900/25 to-orange-100/40 dark:to-orange-900/20 rounded-full blur-2xl pointer-events-none"
        aria-hidden="true"
      />

      <div class="container mx-auto px-4 md:px-6 max-w-6xl text-center relative">
        <AnimatedSection animation="fade-up" delay={0} duration={500}>
          <p class="text-sm font-medium uppercase tracking-wide text-emerald-600 dark:text-emerald-400 mb-4">
            Insights & Guides
          </p>
        </AnimatedSection>

        <AnimatedSection animation="fade-up" delay={100} duration={600}>
          <h1 class="font-serif text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold text-gray-900 dark:text-gray-100 tracking-tight mb-6 text-balance">
            Latest <span class="bg-linear-to-r from-emerald-600 to-emerald-700 bg-clip-text text-transparent">Insights</span>
          </h1>
        </AnimatedSection>

        <AnimatedSection animation="fade-up" delay={200} duration={600}>
          <!-- CUSTOMIZE: Update this description to match your blog's focus -->
          <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto mb-8">
            Practical guides and insights to help you build better websites, improve performance, and grow your business online.
          </p>
        </AnimatedSection>

        <!-- Category filter pills -->
        {allCategories.length > 0 && (
          <AnimatedSection animation="fade-up" delay={300} duration={600}>
            <div id="category-filters" class="flex flex-wrap justify-center gap-2 mt-8" role="tablist" aria-label="Filter posts by category">
              <button
                type="button"
                role="tab"
                aria-selected="true"
                data-category="all"
                class="category-pill category-pill--active"
              >
                All Posts
              </button>
              {allCategories.slice(0, 6).map((category) => (
                <button
                  type="button"
                  role="tab"
                  aria-selected="false"
                  data-category={category}
                  class="category-pill"
                >
                  {category}
                </button>
              ))}
            </div>
          </AnimatedSection>
        )}
      </div>
    </section>

    <!-- Visual connector: Hero → Grid -->
    <SectionConnector variant="wave" color="warm" />

    <!-- Blog Post Grid -->
    <section class="py-12">
      <div class="container mx-auto px-4 md:px-6 max-w-6xl">

        <!-- Posts count -->
        <p id="posts-count" class="text-gray-500 dark:text-gray-400 font-mono text-sm mb-8">
          {sortedPosts.length} articles
        </p>

        <!-- Post Grid -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {sortedPosts.map((post, index) => (
            <AnimatedSection animation="fade-up" delay={index < 6 ? index * 50 : 0} duration={500}>
              <div data-categories={JSON.stringify(post.data.categories || [])} class="blog-card-wrapper">
              <BlogCard
                title={post.data.title}
                slug={post.slug}
                date={post.data.date}
                excerpt={post.data.excerpt}
                description={post.data.description}
                author={post.data.author}
                categories={post.data.categories}
                image={post.data.image}
                featured={index === 0}
              />
              </div>
            </AnimatedSection>
          ))}
        </div>

        <!-- Empty state -->
        {sortedPosts.length === 0 && (
          <div class="text-center py-16">
            <p class="text-gray-500 dark:text-gray-400 font-mono">No posts yet. Check back soon!</p>
          </div>
        )}
      </div>
    </section>

    <!-- Visual connector: Grid → CTA -->
    <SectionConnector variant="curve" color="cool" />

    <!-- CTA Section -->
    <CTASection
    headline="Ready to start your project?"
    description="Tell us what you're working on and we'll see how we can help."
    primaryText="Get Started"
      primaryUrl="/contact/"
    />
  </main>
  </PageBackground>
</Layout>

<style>
  /* Category filter pill styles */
  .category-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 9999px;
    border: 1px solid var(--color-glass-border);
    background: transparent;
    color: var(--color-fg);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .category-pill:hover {
    background: var(--color-accent-primary-20, rgba(16, 185, 129, 0.2));
    color: var(--color-accent-primary);
  }
  .category-pill--active {
    border-color: transparent;
    background: var(--color-accent-tertiary);
    color: white;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  .category-pill--active:hover {
    background: var(--color-accent-tertiary);
    color: white;
    opacity: 0.9;
  }
  /* Hidden state for filtered-out cards */
  .blog-card-wrapper.hidden {
    display: none;
  }
</style>

<script>
  /**
   * Client-side blog category filtering
   * Filters blog cards by category when filter pills are clicked.
   */
  function initCategoryFilter() {
    const filtersContainer = document.getElementById('category-filters');
    const postsGrid = document.getElementById('posts-grid');
    const postsCount = document.getElementById('posts-count');

    if (!filtersContainer || !postsGrid) return;

    const pills = filtersContainer.querySelectorAll<HTMLButtonElement>('.category-pill');
    const cards = postsGrid.querySelectorAll<HTMLElement>('.blog-card-wrapper');
    const totalPosts = cards.length;

    function filterByCategory(category: string) {
      let visibleCount = 0;

      cards.forEach((card) => {
        const cardCategories: string[] = JSON.parse(card.dataset.categories || '[]');
        const isVisible = category === 'all' || cardCategories.includes(category);

        card.classList.toggle('hidden', !isVisible);
        if (isVisible) visibleCount++;
      });

      // Update the article count
      if (postsCount) {
        postsCount.textContent = category === 'all'
          ? `${totalPosts} articles`
          : `${visibleCount} of ${totalPosts} articles`;
      }

      // Update active pill state
      pills.forEach((pill) => {
        const isActive = pill.dataset.category === category;
        pill.classList.toggle('category-pill--active', isActive);
        pill.setAttribute('aria-selected', String(isActive));
      });

      // Update URL hash (without scrolling)
      if (category === 'all') {
        history.replaceState(null, '', window.location.pathname);
      } else {
        history.replaceState(null, '', `#${encodeURIComponent(category)}`);
      }
    }

    // Add click handlers
    pills.forEach((pill) => {
      pill.addEventListener('click', () => {
        const category = pill.dataset.category || 'all';
        filterByCategory(category);
      });
    });

    // Apply filter from URL hash on load
    const hash = decodeURIComponent(window.location.hash.slice(1));
    if (hash && hash !== 'all') {
      // Verify the hash matches an actual category
      const matchingPill = Array.from(pills).find((p) => p.dataset.category === hash);
      if (matchingPill) {
        filterByCategory(hash);
      }
    }
  }

  // Run on initial load and after View Transitions navigation
  initCategoryFilter();
  document.addEventListener('astro:after-swap', initCategoryFilter);
</script>
